#!/usr/bin/env python3
"""
–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
"""

from database.models import (
    init_db, add_user, get_words_by_level, add_word_to_spaced_repetition,
    get_words_for_review, get_spaced_repetition_stats, update_spaced_repetition
)

def test_all_fixes():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π"""
    print("üöÄ –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π")
    print("=" * 60)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
    init_db()
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    test_user_id = 88888
    add_user(test_user_id, 'A1')
    
    print("‚úÖ 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
    print("‚úÖ 2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω")
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
    words = get_words_by_level('A1', 3)
    if not words:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ª–æ–≤–∞")
        return False
    
    print(f"‚úÖ 3. –ü–æ–ª—É—á–µ–Ω–æ {len(words)} —Å–ª–æ–≤")
    
    for word in words:
        add_word_to_spaced_repetition(test_user_id, word['word_id'], word['word'])
    
    print("‚úÖ 4. –°–ª–æ–≤–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ")
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
    review_words = get_words_for_review(test_user_id, 3)
    print(f"‚úÖ 5. –°–ª–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: {len(review_words)}")
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats = get_spaced_repetition_stats(test_user_id)
    print("‚úÖ 6. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
    if review_words:
        test_word = review_words[0]
        print(f"‚úÖ 7. –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–ª–æ–≤–æ: {test_word['word']}")
        
        # –°–∏–º—É–ª–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        for i in range(3):
            update_spaced_repetition(test_word['id'], True)
            updated_words = get_words_for_review(test_user_id, 1)
            if updated_words:
                updated_word = updated_words[0]
                consecutive_correct = updated_word['consecutive_correct']
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
                if consecutive_correct == 0:
                    expected_interval = 1
                elif consecutive_correct == 1:
                    expected_interval = 3
                elif consecutive_correct == 2:
                    expected_interval = 7
                else:
                    expected_interval = 7 + (consecutive_correct - 1) * 7
                
                print(f"   ‚úÖ {i+1}-–π –æ—Ç–≤–µ—Ç: –∏–Ω—Ç–µ—Ä–≤–∞–ª {updated_word['interval_days']} –¥–Ω. (–æ–∂–∏–¥–∞–µ—Ç—Å—è: {expected_interval})")
                
                if updated_word['interval_days'] != expected_interval:
                    print(f"   ‚ùå –û—à–∏–±–∫–∞ –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ!")
                    return False
        
        # –°–∏–º—É–ª–∏—Ä—É–µ–º –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        update_spaced_repetition(test_word['id'], False)
        updated_words = get_words_for_review(test_user_id, 1)
        if updated_words:
            updated_word = updated_words[0]
            if updated_word['interval_days'] == 1:
                print("   ‚úÖ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–±—Ä–æ—à–µ–Ω")
            else:
                print("   ‚ùå –û—à–∏–±–∫–∞ –≤ —Å–±—Ä–æ—Å–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞!")
                return False
    
    print("\n‚úÖ 8. –ê–ª–≥–æ—Ä–∏—Ç–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (–±–µ–∑ Markdown)
    print("\nüìù –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:")
    
    # –°–æ–æ–±—â–µ–Ω–∏–µ /review
    review_text = "üîÑ –ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ\n\n"
    review_text += "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
    review_text += f"‚Ä¢ –í—Å–µ–≥–æ —Å–ª–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ: {stats['total_words']}\n"
    review_text += f"‚Ä¢ –°–ª–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è: {stats['due_today']}\n"
    review_text += f"‚Ä¢ –í—Å–µ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π: {stats['total_reviews']}\n\n"
    
    review_text += f"üìù –°–ª–æ–≤–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è ({len(review_words)}):\n\n"
    
    for i, word_data in enumerate(review_words, 1):
        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        word = word_data['word'].replace('_', '\\_').replace('*', '\\*').replace('`', '\\`')
        transcription = word_data['transcription'].replace('_', '\\_').replace('*', '\\*').replace('`', '\\`')
        translation = word_data['translation'].replace('_', '\\_').replace('*', '\\*').replace('`', '\\`')
        example = word_data['example'].replace('_', '\\_').replace('*', '\\*').replace('`', '\\`')
        
        review_text += (
            f"{i}. {word} [{transcription}]\n"
            f"   –ü–µ—Ä–µ–≤–æ–¥: {translation}\n"
            f"   –ü—Ä–∏–º–µ—Ä: {example}\n"
            f"   –ò–Ω—Ç–µ—Ä–≤–∞–ª: {word_data['interval_days']} –¥–Ω.\n\n"
        )
    
    review_text += "üí° –ò—Å–ø–æ–ª—å–∑—É–π /review_test –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–∏—Ö —Å–ª–æ–≤!"
    
    print("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ /review —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫")
    
    # –°–æ–æ–±—â–µ–Ω–∏–µ /stats
    stats_text = (
        f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è\n\n"
        f"üéØ –£—Ä–æ–≤–µ–Ω—å: A1\n"
        f"üìö –í—ã—É—á–µ–Ω–æ —Å–ª–æ–≤: 0\n"
        f"üß™ –ü—Ä–æ–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: 0\n"
        f"‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: 0\n"
        f"‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: 0\n"
        f"üìà –¢–æ—á–Ω–æ—Å—Ç—å: 0.0%\n\n"
    )
    
    stats_text += (
        f"üîÑ –ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ\n"
        f"üìù –°–ª–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ: {stats['total_words']}\n"
        f"‚è∞ –°–ª–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è: {stats['due_today']}\n"
        f"üîÑ –í—Å–µ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π: {stats['total_reviews']}\n"
        f"üìä –°—Ä–µ–¥–Ω–∏–π ease factor: {stats['avg_ease_factor']}\n\n"
    )
    
    print("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ /stats —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫")
    
    # –°–æ–æ–±—â–µ–Ω–∏–µ /help
    help_text = (
        "ü§ñ –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º\n\n"
        "üìö –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "‚Ä¢ /start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º\n"
        "‚Ä¢ /words - –ü–æ–ª—É—á–∏—Ç—å 5 —Å–ª–æ–≤ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è\n"
        "‚Ä¢ /test - –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –ø–æ —Å–ª–æ–≤–∞–º\n"
        "‚Ä¢ /stats - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\n"
        "‚Ä¢ /help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n\n"
        "üîÑ –ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ:\n"
        "‚Ä¢ /review - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è\n"
        "‚Ä¢ /review_test - –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è\n\n"
        "üîÑ –ê–ª–≥–æ—Ä–∏—Ç–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è:\n"
        "‚Ä¢ 1-–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 1 –¥–µ–Ω—å\n"
        "‚Ä¢ 2-–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 –¥–Ω—è\n"
        "‚Ä¢ 3-–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é\n"
        "‚Ä¢ –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ: –∏–Ω—Ç–µ—Ä–≤–∞–ª —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –Ω–µ–¥–µ–ª—é\n"
        "‚Ä¢ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: —Å–±—Ä–æ—Å –Ω–∞ 1 –¥–µ–Ω—å\n\n"
    )
    
    print("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ /help —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫")
    
    print("\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
    return True

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    if test_all_fixes():
        print("\n‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")
        print("\nüìã –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:")
        print("‚Ä¢ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏")
        print("‚Ä¢ –ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ")
        print("‚Ä¢ –ù–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ (1-3-7-14-21...)")
        print("‚Ä¢ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –±–µ–∑ Markdown")
        print("‚Ä¢ –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤")
        print("‚Ä¢ –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞")
        print("\nüöÄ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!")
    else:
        print("\n‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã!")

if __name__ == "__main__":
    main() 